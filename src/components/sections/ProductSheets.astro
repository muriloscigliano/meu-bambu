---
import Button from '../Button.astro';
import Icon from '../Icon.astro';

interface Props {
	title: string;
	price: string;
	description: string;
	features: string[];
	ctaLabel: string;
	ctaHref: string;
}

const { title, price, description, features, ctaLabel, ctaHref } = Astro.props as Props;
---

<section class="product-sheets" data-section aria-labelledby="product-sheets-title">
	<div class="product-sheets__container">
		<figure class="product-sheets__media">
			<div class="product-sheets__image-wrap" data-animate="image-reveal">
				<img src="/images/floresta-bambu.jpg" alt="Lâminas de bambu flexíveis para móveis e marcenaria - Meu Bambu" loading="lazy" width="728" height="430" />
			</div>
		</figure>

		<article class="product-sheets__details">
			<header>
				<h2 id="product-sheets-title" class="product-sheets__title" data-split="heading">{title}</h2>
				<p class="product-sheets__price" data-animate="fade-in">{price}</p>
			</header>
			<p class="product-sheets__desc" data-animate="fade-in">{description}</p>

			<ul class="product-sheets__bullets" data-animate="stagger" aria-label="Características do produto">
				{features.map((feature) => (
					<li data-stagger-item>
						<Icon name="checkmark" size={18} class="checkmark-icon" aria-hidden="true" />
						<span>{feature}</span>
					</li>
				))}
			</ul>

			<div class="product-sheets__options" data-animate="stagger">
				<div class="product-sheets__divider" role="separator" data-stagger-item></div>
				<div class="product-sheets__option-row" data-stagger-item>
					<fieldset class="product-sheets__option-group">
						<legend class="product-sheets__option-label">Espessura</legend>
						<div class="product-sheets__chips" role="radiogroup" aria-label="Selecione a espessura">
							<button type="button" class="chip-option" role="radio" aria-checked="true" data-value="0.6mm">0.6mm</button>
						</div>
					</fieldset>
					<div class="product-sheets__row-divider" role="separator" aria-hidden="true"></div>
					<fieldset class="product-sheets__option-group">
						<legend class="product-sheets__option-label">Tamanho</legend>
						<div class="product-sheets__chips" role="radiogroup" aria-label="Selecione o tamanho">
							<button type="button" class="chip-option chip-option--size" role="radio" aria-checked="true" data-value="200x60cm">200x60cm</button>
						</div>
					</fieldset>
				</div>
				<div class="product-sheets__divider" role="separator" data-stagger-item></div>
			</div>

			<div data-animate="fade-in">
				<Button text={ctaLabel} type="button" theme="dark" class="product-sheets__buy-btn" />
			</div>
		</article>
	</div>

	<script is:inline>
		(function() {
			const sheetsRoot = document.currentScript?.closest('.product-sheets');
			if (!sheetsRoot) return;

			// Handle click selection
			sheetsRoot.addEventListener('click', (e) => {
				const target = e.target;
				if (!(target instanceof HTMLElement)) return;
				const btn = target.closest('button.chip-option');
				if (!btn) return;
				selectRadio(btn);
			});

			// Handle keyboard navigation (arrow keys)
			sheetsRoot.addEventListener('keydown', (e) => {
				const target = e.target;
				if (!(target instanceof HTMLElement)) return;
				if (!target.matches('button.chip-option')) return;

				const group = target.closest('[role="radiogroup"]');
				if (!group) return;

				const buttons = Array.from(group.querySelectorAll('button.chip-option'));
				const currentIndex = buttons.indexOf(target);
				let nextIndex = currentIndex;

				switch (e.key) {
					case 'ArrowRight':
					case 'ArrowDown':
						nextIndex = (currentIndex + 1) % buttons.length;
						e.preventDefault();
						break;
					case 'ArrowLeft':
					case 'ArrowUp':
						nextIndex = (currentIndex - 1 + buttons.length) % buttons.length;
						e.preventDefault();
						break;
					case 'Home':
						nextIndex = 0;
						e.preventDefault();
						break;
					case 'End':
						nextIndex = buttons.length - 1;
						e.preventDefault();
						break;
					default:
						return;
				}

				const nextButton = buttons[nextIndex];
				if (nextButton) {
					selectRadio(nextButton);
					nextButton.focus();
				}
			});

			function selectRadio(btn) {
				const group = btn.closest('[role="radiogroup"]');
				if (!group) return;
				group.querySelectorAll('button.chip-option').forEach((b) => {
					b.setAttribute('aria-checked', 'false');
					b.setAttribute('tabindex', '-1');
				});
				btn.setAttribute('aria-checked', 'true');
				btn.setAttribute('tabindex', '0');
			}

			// Set initial tabindex (only checked item is tabbable)
			sheetsRoot.querySelectorAll('[role="radiogroup"]').forEach((group) => {
				const buttons = group.querySelectorAll('button.chip-option');
				buttons.forEach((btn) => {
					if (btn.getAttribute('aria-checked') === 'true') {
						btn.setAttribute('tabindex', '0');
					} else {
						btn.setAttribute('tabindex', '-1');
					}
				});
			});

			// Buy button - open Freely widget
			const buyBtn = sheetsRoot.querySelector('.product-sheets__buy-btn');
			if (buyBtn) {
				buyBtn.addEventListener('click', () => {
					// Get selected options
					const thickness = sheetsRoot.querySelector('[aria-label="Selecione a espessura"] [aria-checked="true"]')?.getAttribute('data-value') || '0.6mm';
					const size = sheetsRoot.querySelector('[aria-label="Selecione o tamanho"] [aria-checked="true"]')?.getAttribute('data-value') || '200x60cm';

					// Debug: log what's available
					console.log('Selected:', { thickness, size, productId: 'lamina-bambu-06mm' });
					console.log('window.Freely:', window.Freely);
					console.log('window.FreelyConfig:', window.FreelyConfig);

					// Try to find and click the Freely widget button
					const freelyBtn = document.querySelector('[data-freely-trigger], #freely-widget button, .freely-launcher');
					if (freelyBtn) {
						console.log('Found Freely button:', freelyBtn);
						freelyBtn.click();
					} else if (window.Freely && typeof window.Freely.open === 'function') {
						console.log('Using Freely.open()');
						window.Freely.open();
					} else {
						// Show alert for now so you can test
						alert(`Produto: Lâmina de Bambu ${thickness} - ${size}\n\nO widget Freely ainda não está disponível. Verifique o console.`);
					}
				});
			}
		})();
	</script>
</section>

<style>
.product-sheets { 
	position: relative; 
	isolation: isolate; 
	min-height: var(--section-min-height);
	display: flex;
	align-items: center;
	background: var(--color-bg-secondary);
	border-top: 1px solid var(--color-line);
	border-bottom: 1px solid var(--color-line);
	padding-block: 90px;
}

.product-sheets__container { 
	max-width: var(--container-max); 
	margin-inline: auto; 
	display: grid; 
	gap: 48px; 
	align-items: center; 
	grid-template-columns: 1fr 1fr;
	padding-inline: 2.25rem;
}

.product-sheets__details { 
	display: flex;
	flex-direction: column;
	gap: 28px;
	padding: 48px;
}

.product-sheets__title { 
	font-family: var(--font-display); 
	font-weight: 900;
	text-transform: uppercase; 
	line-height: 0.9;
	font-size: 64px;
	color: var(--color-text-secondary);
	margin: 0;
}

.product-sheets__price {
	font-family: var(--font-display); 
	font-weight: 900;
	text-transform: uppercase; 
	line-height: 0.9;
	font-size: 36px;
	color: var(--color-text-secondary);
	margin: 0;
}

.product-sheets__desc { 
	font-family: var(--font-sans);
	font-weight: 500;
	font-size: 16px;
	line-height: 1.3;
	color: var(--color-text-primary);
	margin: 0;
	max-width: 52ch;
}

.product-sheets__bullets {
	list-style: none;
	padding: 0;
	margin: 0;
	display: flex;
	flex-direction: column;
	gap: 12px;
}

.product-sheets__bullets li {
	display: flex;
	align-items: center;
	gap: 6px;
	font-family: var(--font-sans);
	font-weight: 500;
	font-size: 16px;
	line-height: 1.1;
	color: var(--color-text-primary);
}

.product-sheets__options {
	display: flex;
	flex-direction: column;
	gap: 24px;
}

.product-sheets__option-row {
	display: flex;
	gap: 24px;
	align-items: flex-start;
}

.product-sheets__row-divider {
	width: 34px;
	height: 0;
	border-top: 1px solid var(--color-border-dark);
	align-self: center;
	transform: rotate(90deg);
}

.product-sheets__divider {
	height: 1px;
	width: 100%;
	background: var(--color-border-dark);
}

.product-sheets__option-group {
	display: flex;
	gap: 12px;
	align-items: center;
	border: none;
	padding: 0;
	margin: 0;
}

.product-sheets__option-label {
	font-family: var(--font-sans);
	font-weight: 700;
	font-size: 16px;
	color: var(--color-text-dark);
	margin: 0;
	white-space: nowrap;
}

.product-sheets__chips {
	display: flex;
	gap: 8px;
	flex-wrap: wrap;
}

.chip-option--size {
	min-width: 100px;
}

.product-sheets__cta {
	align-self: flex-start;
	height: 56px;
}

.product-sheets__media {
	position: relative;
	display: flex;
	align-items: center;
	justify-content: center;
}

.product-sheets__image-wrap {
	max-width: 728px;
	width: 100%;
}

.product-sheets__image-wrap img { 
	width: 100%; 
	height: auto;
	display: block;
}

@media (max-width: 1024px) {
	.product-sheets__container {
		grid-template-columns: 1fr;
	}
	
	.product-sheets__details {
		padding: 24px;
	}
	
	.product-sheets__option-row {
		flex-direction: column;
	}
	
	.product-sheets__row-divider {
		display: none;
	}
}

@media (max-width: 768px) {
	.product-sheets__title {
		font-size: 48px;
	}
	
	.product-sheets__price {
		font-size: 28px;
	}
}
</style>
