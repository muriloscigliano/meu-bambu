---
import Button from '../Button.astro';
import Icon from '../Icon.astro';

interface Props {
	title: string;
	price: string;
	description: string;
	features: string[];
	ctaLabel: string;
	ctaHref: string;
}

const { title, price, description, features, ctaLabel, ctaHref } = Astro.props as Props;
---

<section id="comprar" class="product-panels" data-section aria-labelledby="product-panels-title">
	<div class="product-panels__container">
		<article class="product-panels__details">
			<header>
				<h2 id="product-panels-title" class="product-panels__title" data-split="heading" set:html={title.replace(' ', '<br>')}></h2>
				<p class="product-panels__price" data-animate="fade-in">{price}</p>
			</header>
			<p class="product-panels__desc" data-animate="fade-in">{description}</p>

			<ul class="product-panels__bullets" data-animate="stagger" aria-label="Características do produto">
				{features.map((feature) => (
					<li data-stagger-item>
						<Icon name="checkmark" size={18} class="checkmark-icon" aria-hidden="true" />
						<span>{feature}</span>
					</li>
				))}
			</ul>

			<div class="product-panels__options" data-animate="stagger">
				<div class="product-panels__divider" role="separator" data-stagger-item></div>
				<fieldset class="product-panels__option-group" data-stagger-item>
					<legend class="product-panels__option-label">Espessura</legend>
					<div class="product-panels__chips" role="radiogroup" aria-label="Selecione a espessura">
						<button type="button" class="chip-option" role="radio" aria-checked="true" data-value="3mm">3mm</button>
						<button type="button" class="chip-option" role="radio" aria-checked="false" data-value="5mm">5mm</button>
						<button type="button" class="chip-option" role="radio" aria-checked="false" data-value="15mm">15mm</button>
					</div>
				</fieldset>
				<fieldset class="product-panels__option-group" data-stagger-item>
					<legend class="product-panels__option-label">Tamanho</legend>
					<div class="product-panels__chips product-panels__chips--wrap" role="radiogroup" aria-label="Selecione o tamanho">
						<button type="button" class="chip-option chip-option--size" role="radio" aria-checked="true" data-value="200x60cm">200x60cm</button>
						<button type="button" class="chip-option chip-option--size" role="radio" aria-checked="false" data-value="130x28cm">130x28cm</button>
						<button type="button" class="chip-option chip-option--size" role="radio" aria-checked="false" data-value="125x28cm">125x28cm</button>
						<button type="button" class="chip-option chip-option--size" role="radio" aria-checked="false" data-value="115x28cm">115x28cm</button>
						<button type="button" class="chip-option chip-option--size" role="radio" aria-checked="false" data-value="105x28cm">105x28cm</button>
						<button type="button" class="chip-option chip-option--size" role="radio" aria-checked="false" data-value="95x28cm">95x28cm</button>
						<button type="button" class="chip-option chip-option--size" role="radio" aria-checked="false" data-value="90x28cm">90x28cm</button>
						<button type="button" class="chip-option chip-option--size" role="radio" aria-checked="false" data-value="80x28cm">80x28cm</button>
					</div>
				</fieldset>
				<div class="product-panels__divider" role="separator" data-stagger-item></div>
			</div>

			<div data-animate="fade-in">
				<Button text={ctaLabel} type="button" theme="dark" class="product-panels__buy-btn" />
			</div>
		</article>

		<figure class="product-panels__media">
			<div class="product-panels__image-wrap" data-animate="image-reveal">
				<img src="/images/floresta-bambu.jpg" alt="Painéis de bambu premium com núcleo vertical - Meu Bambu" loading="lazy" width="728" height="430" />
			</div>
		</figure>
	</div>

	<script is:inline>
		(function() {
			const panelsRoot = document.currentScript?.closest('.product-panels');
			if (!panelsRoot) return;

			// Handle click selection
			panelsRoot.addEventListener('click', (e) => {
				const target = e.target;
				if (!(target instanceof HTMLElement)) return;
				const btn = target.closest('button.chip-option');
				if (!btn) return;
				selectRadio(btn);
			});

			// Handle keyboard navigation (arrow keys)
			panelsRoot.addEventListener('keydown', (e) => {
				const target = e.target;
				if (!(target instanceof HTMLElement)) return;
				if (!target.matches('button.chip-option')) return;

				const group = target.closest('[role="radiogroup"]');
				if (!group) return;

				const buttons = Array.from(group.querySelectorAll('button.chip-option'));
				const currentIndex = buttons.indexOf(target);
				let nextIndex = currentIndex;

				switch (e.key) {
					case 'ArrowRight':
					case 'ArrowDown':
						nextIndex = (currentIndex + 1) % buttons.length;
						e.preventDefault();
						break;
					case 'ArrowLeft':
					case 'ArrowUp':
						nextIndex = (currentIndex - 1 + buttons.length) % buttons.length;
						e.preventDefault();
						break;
					case 'Home':
						nextIndex = 0;
						e.preventDefault();
						break;
					case 'End':
						nextIndex = buttons.length - 1;
						e.preventDefault();
						break;
					default:
						return;
				}

				const nextButton = buttons[nextIndex];
				if (nextButton) {
					selectRadio(nextButton);
					nextButton.focus();
				}
			});

			function selectRadio(btn) {
				const group = btn.closest('[role="radiogroup"]');
				if (!group) return;
				group.querySelectorAll('button.chip-option').forEach((b) => {
					b.setAttribute('aria-checked', 'false');
					b.setAttribute('tabindex', '-1');
				});
				btn.setAttribute('aria-checked', 'true');
				btn.setAttribute('tabindex', '0');
			}

			// Set initial tabindex (only checked item is tabbable)
			panelsRoot.querySelectorAll('[role="radiogroup"]').forEach((group) => {
				const buttons = group.querySelectorAll('button.chip-option');
				buttons.forEach((btn) => {
					if (btn.getAttribute('aria-checked') === 'true') {
						btn.setAttribute('tabindex', '0');
					} else {
						btn.setAttribute('tabindex', '-1');
					}
				});
			});

			// Buy button - open Freely widget with selected variant
			const buyBtn = panelsRoot.querySelector('.product-panels__buy-btn');
			if (buyBtn) {
				buyBtn.addEventListener('click', () => {
					// Get selected thickness and size
					const thickness = panelsRoot.querySelector('[aria-label="Selecione a espessura"] [aria-checked="true"]')?.getAttribute('data-value') || '3mm';
					const size = panelsRoot.querySelector('[aria-label="Selecione o tamanho"] [aria-checked="true"]')?.getAttribute('data-value') || '200x60cm';

					// Product ID based on thickness (synced with Freely)
					const productIds = {
						'3mm': 'painel-bambu-3mm',
						'5mm': 'painel-bambu-5mm',
						'15mm': 'painel-bambu-15mm'
					};
					const productId = productIds[thickness] || 'painel-bambu-3mm';

					// Debug: log what's available
					console.log('Selected:', { thickness, size, productId });
					console.log('window.Freely:', window.Freely);
					console.log('window.FreelyConfig:', window.FreelyConfig);

					// Try to find and click the Freely widget button
					const freelyBtn = document.querySelector('[data-freely-trigger], #freely-widget button, .freely-launcher');
					if (freelyBtn) {
						console.log('Found Freely button:', freelyBtn);
						freelyBtn.click();
					} else if (window.Freely && typeof window.Freely.open === 'function') {
						console.log('Using Freely.open()');
						window.Freely.open();
					} else {
						// Show alert for now so you can test
						alert(`Produto: Painel de Bambu ${thickness} - ${size}\n\nO widget Freely ainda não está disponível. Verifique o console.`);
					}
				});
			}
		})();
	</script>
</section>

<style>
.product-panels {
	position: relative;
	isolation: isolate;
	min-height: var(--section-min-height);
	display: flex;
	align-items: center;
	background: #ece4d1;
	border-top: 1px solid var(--color-line);
	border-bottom: 1px solid var(--color-line);
	padding-block: 90px;
}

.product-panels__container { 
	max-width: var(--container-max); 
	margin-inline: auto; 
	display: grid; 
	gap: 48px; 
	align-items: center; 
	grid-template-columns: 1fr 1fr;
	padding-inline: 2.25rem;
}

.product-panels__details { 
	display: flex;
	flex-direction: column;
	gap: 28px;
	padding: 48px;
}

.product-panels__title { 
	font-family: var(--font-display); 
	font-weight: 900;
	text-transform: uppercase; 
	line-height: 0.9;
	font-size: 64px;
	color: var(--color-text-secondary);
	margin: 0;
}

.product-panels__price {
	font-family: var(--font-display); 
	font-weight: 900;
	text-transform: uppercase; 
	line-height: 0.9;
	font-size: 36px;
	color: var(--color-text-secondary);
	margin: 0;
}

.product-panels__desc { 
	font-family: var(--font-sans);
	font-weight: 500;
	font-size: 16px;
	line-height: 1.3;
	color: var(--color-text-primary);
	margin: 0;
	max-width: 52ch;
}

.product-panels__bullets {
	list-style: none;
	padding: 0;
	margin: 0;
	display: flex;
	flex-direction: column;
	gap: 12px;
}

.product-panels__bullets li {
	display: flex;
	align-items: center;
	gap: 6px;
	font-family: var(--font-sans);
	font-weight: 500;
	font-size: 16px;
	line-height: 1.1;
	color: var(--color-text-primary);
}

.product-panels__options {
	display: flex;
	flex-direction: column;
	gap: 24px;
}

.product-panels__divider {
	height: 1px;
	width: 100%;
	background: var(--color-border);
}

.product-panels__option-group {
	display: flex;
	flex-direction: column;
	gap: 12px;
	border: none;
	padding: 0;
	margin: 0;
}

.product-panels__option-label {
	font-family: var(--font-sans);
	font-weight: 700;
	font-size: 16px;
	color: var(--color-text-dark);
	margin: 0;
}

.product-panels__chips {
	display: flex;
	gap: 8px;
	flex-wrap: nowrap;
}

.product-panels__chips--wrap {
	flex-wrap: wrap;
	gap: 12px;
}

.chip-option--size {
	min-width: 100px;
}

.product-panels__cta {
	align-self: flex-start;
	height: 56px;
}

.product-panels__media {
	position: relative;
	display: flex;
	align-items: center;
	justify-content: center;
}

.product-panels__image-wrap {
	max-width: 728px;
	width: 100%;
}

.product-panels__image-wrap img { 
	width: 100%; 
	height: auto;
	display: block;
}

@media (max-width: 1024px) {
	.product-panels__container {
		grid-template-columns: 1fr;
	}
	
	.product-panels__details {
		order: 2;
		padding: 24px;
	}
	
	.product-panels__media {
		order: 1;
	}
}

@media (max-width: 768px) {
	.product-panels__title {
		font-size: 48px;
	}
	
	.product-panels__price {
		font-size: 28px;
	}
}
</style>
