---
export const prerender = false;

// Temporarily disabled - redirect to coming soon
return Astro.redirect('/em-breve');

import Admin from '../../../layouts/Admin.astro';

let admin = null;
let orders: any[] = [];
let total = 0;
let page = 1;
let totalPages = 1;
let error = null;
let statusFilter: string = 'all';
let searchQuery: string = '';

const formatCurrency = (value: number) => {
	return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
};

const formatDate = (dateStr: string) => {
	return new Date(dateStr).toLocaleDateString('pt-BR', {
		day: '2-digit',
		month: '2-digit',
		year: 'numeric',
		hour: '2-digit',
		minute: '2-digit',
	});
};

const getStatusLabel = (status: string) => {
	const labels: Record<string, string> = {
		pending: 'Pendente',
		processing: 'Processando',
		shipped: 'Enviado',
		delivered: 'Entregue',
		cancelled: 'Cancelado',
	};
	return labels[status] || status;
};

const getPaymentMethodLabel = (method: string) => {
	const labels: Record<string, string> = {
		pix: 'PIX',
		credit_card: 'Cartão',
		boleto: 'Boleto',
	};
	return labels[method] || method;
};
---

<Admin title="Pedidos | Meu Bambu Admin" activeTab="pedidos">
	<div class="dashboard__header">
		<h1 class="dashboard__title">Pedidos</h1>
		<p class="dashboard__subtitle">{total} pedidos encontrados</p>
	</div>

	{error && (
		<div class="alert alert--error">
			<p>{error}</p>
		</div>
	)}

	<!-- Filters -->
	<form method="GET" class="admin-filters">
		<div class="admin-search">
			<svg class="admin-search__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
				<path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" stroke-linecap="round" stroke-linejoin="round"/>
			</svg>
			<input
				type="text"
				name="search"
				class="admin-search__input"
				placeholder="Buscar por número, cliente ou email..."
				value={searchQuery}
			/>
		</div>

		<select name="status" class="admin-filter-select" onchange="this.form.submit()">
			<option value="all" selected={statusFilter === 'all'}>Todos os status</option>
			<option value="pending" selected={statusFilter === 'pending'}>Pendente</option>
			<option value="processing" selected={statusFilter === 'processing'}>Processando</option>
			<option value="shipped" selected={statusFilter === 'shipped'}>Enviado</option>
			<option value="delivered" selected={statusFilter === 'delivered'}>Entregue</option>
			<option value="cancelled" selected={statusFilter === 'cancelled'}>Cancelado</option>
		</select>

		<button type="submit" class="quick-action-btn">
			<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
				<path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" stroke-linecap="round" stroke-linejoin="round"/>
			</svg>
			Buscar
		</button>
	</form>

	<!-- Orders Table -->
	<div class="dashboard__card">
		{orders.length === 0 ? (
			<div class="empty-state">
				<svg class="empty-state__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
					<path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" stroke-linecap="round" stroke-linejoin="round"/>
				</svg>
				<h3 class="empty-state__title">Nenhum pedido encontrado</h3>
				<p class="empty-state__text">Tente ajustar os filtros de busca</p>
			</div>
		) : (
			<>
				<table class="admin-table">
					<thead>
						<tr>
							<th>Pedido</th>
							<th>Cliente</th>
							<th>Data</th>
							<th>Pagamento</th>
							<th>Status</th>
							<th>Total</th>
							<th>Ações</th>
						</tr>
					</thead>
					<tbody>
						{orders.map(order => (
							<tr>
								<td class="table-cell--bold">{order.orderNumber}</td>
								<td>
									<div class="customer-row">
										<div class="customer-row__avatar">
											{order.customer.name.charAt(0).toUpperCase()}
										</div>
										<div class="customer-row__info">
											<span class="customer-row__name">{order.customer.name}</span>
											<span class="customer-row__email">{order.customer.email}</span>
										</div>
									</div>
								</td>
								<td class="table-cell--muted">{formatDate(order.createdAt)}</td>
								<td>{getPaymentMethodLabel(order.paymentMethod)}</td>
								<td>
									<span class={`status-badge status-badge--${order.status}`}>
										{getStatusLabel(order.status)}
									</span>
								</td>
								<td class="table-cell--bold">{formatCurrency(order.total)}</td>
								<td>
									<div class="table-actions">
										<a href={`/admin/pedidos/${order.id}`} class="table-action-btn table-action-btn--view" title="Ver detalhes">
											<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
												<path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" stroke-linecap="round" stroke-linejoin="round"/>
												<path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" stroke-linecap="round" stroke-linejoin="round"/>
											</svg>
										</a>
									</div>
								</td>
							</tr>
						))}
					</tbody>
				</table>

				<!-- Pagination -->
				{totalPages > 1 && (
					<div class="pagination">
						<span class="pagination__info">
							Mostrando {(page - 1) * 10 + 1} - {Math.min(page * 10, total)} de {total}
						</span>
						<div class="pagination__buttons">
							{page > 1 && (
								<a href={`/admin/pedidos?status=${statusFilter}&search=${searchQuery}&page=${page - 1}`} class="pagination__btn">
									Anterior
								</a>
							)}
							{Array.from({ length: totalPages }, (_, i) => i + 1).map(p => (
								<a
									href={`/admin/pedidos?status=${statusFilter}&search=${searchQuery}&page=${p}`}
									class={`pagination__btn ${p === page ? 'pagination__btn--active' : ''}`}
								>
									{p}
								</a>
							))}
							{page < totalPages && (
								<a href={`/admin/pedidos?status=${statusFilter}&search=${searchQuery}&page=${page + 1}`} class="pagination__btn">
									Próximo
								</a>
							)}
						</div>
					</div>
				)}
			</>
		)}
	</div>
</Admin>
