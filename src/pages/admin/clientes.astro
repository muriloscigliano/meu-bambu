---
export const prerender = false;

// Temporarily disabled - redirect to coming soon
return Astro.redirect('/em-breve');

import Admin from '../../layouts/Admin.astro';

let admin = null;
let customers: any[] = [];
let total = 0;
let page = 1;
let totalPages = 1;
let error = null;
const searchQuery = '';

const formatCurrency = (value: number) => {
	return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
};

const formatDate = (dateStr: string) => {
	return new Date(dateStr).toLocaleDateString('pt-BR', {
		day: '2-digit',
		month: '2-digit',
		year: 'numeric',
	});
};
---

<Admin title="Clientes | Meu Bambu Admin" activeTab="clientes">
	<div class="dashboard__header">
		<h1 class="dashboard__title">Clientes</h1>
		<p class="dashboard__subtitle">{total} clientes cadastrados</p>
	</div>

	{error && (
		<div class="alert alert--error">
			<p>{error}</p>
		</div>
	)}

	<!-- Filters -->
	<form method="GET" class="admin-filters">
		<div class="admin-search">
			<svg class="admin-search__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
				<path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" stroke-linecap="round" stroke-linejoin="round"/>
			</svg>
			<input
				type="text"
				name="search"
				class="admin-search__input"
				placeholder="Buscar por nome ou email..."
				value={searchQuery}
			/>
		</div>

		<button type="submit" class="quick-action-btn">
			<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
				<path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" stroke-linecap="round" stroke-linejoin="round"/>
			</svg>
			Buscar
		</button>
	</form>

	<!-- Customers Table -->
	<div class="dashboard__card">
		{customers.length === 0 ? (
			<div class="empty-state">
				<svg class="empty-state__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
					<path d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" stroke-linecap="round" stroke-linejoin="round"/>
				</svg>
				<h3 class="empty-state__title">Nenhum cliente encontrado</h3>
				<p class="empty-state__text">Tente ajustar os filtros de busca</p>
			</div>
		) : (
			<>
				<table class="admin-table">
					<thead>
						<tr>
							<th>Cliente</th>
							<th>Telefone</th>
							<th>Pedidos</th>
							<th>Total Gasto</th>
							<th>Último Pedido</th>
							<th>Cliente desde</th>
						</tr>
					</thead>
					<tbody>
						{customers.map(customer => (
							<tr>
								<td>
									<div class="customer-row">
										<div class="customer-row__avatar">
											{customer.name.charAt(0).toUpperCase()}
										</div>
										<div class="customer-row__info">
											<span class="customer-row__name">{customer.name}</span>
											<span class="customer-row__email">{customer.email}</span>
										</div>
									</div>
								</td>
								<td class="table-cell--muted">{customer.phone || '-'}</td>
								<td class="table-cell--bold">{customer.ordersCount}</td>
								<td class="table-cell--accent">{formatCurrency(customer.totalSpent)}</td>
								<td class="table-cell--muted">
									{customer.lastOrderDate ? formatDate(customer.lastOrderDate) : '-'}
								</td>
								<td class="table-cell--muted">{formatDate(customer.createdAt)}</td>
							</tr>
						))}
					</tbody>
				</table>

				<!-- Pagination -->
				{totalPages > 1 && (
					<div class="pagination">
						<span class="pagination__info">
							Mostrando {(page - 1) * 10 + 1} - {Math.min(page * 10, total)} de {total}
						</span>
						<div class="pagination__buttons">
							{page > 1 && (
								<a href={`/admin/clientes?search=${searchQuery}&page=${page - 1}`} class="pagination__btn">
									Anterior
								</a>
							)}
							{Array.from({ length: totalPages }, (_, i) => i + 1).map(p => (
								<a
									href={`/admin/clientes?search=${searchQuery}&page=${p}`}
									class={`pagination__btn ${p === page ? 'pagination__btn--active' : ''}`}
								>
									{p}
								</a>
							))}
							{page < totalPages && (
								<a href={`/admin/clientes?search=${searchQuery}&page=${page + 1}`} class="pagination__btn">
									Próximo
								</a>
							)}
						</div>
					</div>
				)}
			</>
		)}
	</div>
</Admin>
