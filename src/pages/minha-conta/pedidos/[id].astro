---
export const prerender = false;

// Temporarily disabled - redirect to coming soon
return Astro.redirect('/em-breve');

import Dashboard from '../../../layouts/Dashboard.astro';

const { id } = Astro.params;
let order: any = null;
let error = null;

const formatDate = (date: string) => {
	return new Date(date).toLocaleDateString('pt-BR', {
		day: '2-digit',
		month: 'long',
		year: 'numeric',
		hour: '2-digit',
		minute: '2-digit'
	});
};

const formatCurrency = (value: number) => {
	return new Intl.NumberFormat('pt-BR', {
		style: 'currency',
		currency: 'BRL'
	}).format(value);
};

const getStatusLabel = (status: string) => {
	const labels: Record<string, string> = {
		pending: 'Aguardando pagamento',
		processing: 'Processando',
		shipped: 'Enviado',
		delivered: 'Entregue',
		cancelled: 'Cancelado'
	};
	return labels[status] || status;
};

const canCancel = order && ['pending', 'processing'].includes(order.status);
const canRefund = order && ['delivered'].includes(order.status);

const timelineSteps = [
	{ id: 'pending', label: 'Pedido recebido' },
	{ id: 'processing', label: 'Processando' },
	{ id: 'shipped', label: 'Enviado' },
	{ id: 'delivered', label: 'Entregue' }
];

const getTimelineStatus = (stepId: string, currentStatus: string) => {
	const order = ['pending', 'processing', 'shipped', 'delivered'];
	const stepIndex = order.indexOf(stepId);
	const currentIndex = order.indexOf(currentStatus);

	if (currentStatus === 'cancelled') return 'cancelled';
	if (stepIndex < currentIndex) return 'completed';
	if (stepIndex === currentIndex) return 'current';
	return 'pending';
};
---

<Dashboard title={`Pedido #${order?.orderNumber || id} | Meu Bambu`} activeTab="pedidos">
	<div class="order-details">
		<a href="/minha-conta" class="back-link">
			<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
				<path d="M15 19l-7-7 7-7" stroke-linecap="round" stroke-linejoin="round"/>
			</svg>
			Voltar para pedidos
		</a>

		{error && (
			<div class="error-message">
				<p>{error}</p>
			</div>
		)}

		{order && (
			<>
				<div class="order-details__header">
					<div class="order-details__info">
						<h1>Pedido #{order.orderNumber}</h1>
						<p class="order-details__meta">
							Realizado em {formatDate(order.createdAt)}
						</p>
					</div>
					<div class="order-details__actions">
						{canCancel && (
							<form method="POST">
								<input type="hidden" name="action" value="cancel" />
								<button type="submit" class="btn-danger" onclick="return confirm('Tem certeza que deseja cancelar este pedido?')">
									Cancelar pedido
								</button>
							</form>
						)}
						{canRefund && (
							<form method="POST">
								<input type="hidden" name="action" value="refund" />
								<button type="submit" class="btn-secondary" onclick="return confirm('Solicitar reembolso para este pedido?')">
									Solicitar reembolso
								</button>
							</form>
						)}
					</div>
				</div>

				<div class="order-grid">
					<!-- Status Timeline -->
					<div class="dashboard__card">
						<div class="dashboard__card-header">
							<h2 class="dashboard__card-title">Status do pedido</h2>
							<span class={`status-badge status-badge--${order.status}`}>
								{getStatusLabel(order.status)}
							</span>
						</div>

						{order.status !== 'cancelled' ? (
							<div class="order-timeline">
								{timelineSteps.map(step => {
									const status = getTimelineStatus(step.id, order.status);
									const stepDate = order.statusHistory?.find((h: any) => h.status === step.id)?.date;
									return (
										<div class={`timeline-item timeline-item--${status}`}>
											<div class="timeline-item__dot"></div>
											<div class="timeline-item__content">
												<span class="timeline-item__title">{step.label}</span>
												{stepDate && (
													<span class="timeline-item__date">{formatDate(stepDate)}</span>
												)}
											</div>
										</div>
									);
								})}
							</div>
						) : (
							<div class="cancelled-notice">
								<p>Este pedido foi cancelado em {formatDate(order.cancelledAt)}</p>
							</div>
						)}

						{order.tracking && (
							<div class="tracking-info">
								<p class="tracking-label">Código de rastreio:</p>
								<a href={order.tracking.url} target="_blank" rel="noopener" class="tracking-code">
									{order.tracking.code}
									<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
										<path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6M15 3h6v6M10 14L21 3" stroke-linecap="round" stroke-linejoin="round"/>
									</svg>
								</a>
							</div>
						)}
					</div>

					<!-- Order Items -->
					<div class="dashboard__card">
						<div class="dashboard__card-header">
							<h2 class="dashboard__card-title">Itens do pedido</h2>
						</div>

						<div class="order-items">
							{order.items.map((item: any) => (
								<div class="order-product">
									<img src={item.image || '/images/floresta-bambu.jpg'} alt={item.name} class="order-product__image" />
									<div class="order-product__info">
										<h3 class="order-product__name">{item.name}</h3>
										<p class="order-product__variant">
											{item.variant} • Qty: {item.quantity}
										</p>
										<p class="order-product__price">{formatCurrency(item.price * item.quantity)}</p>
									</div>
								</div>
							))}
						</div>

						<div class="order-summary">
							<div class="order-summary__row">
								<span>Subtotal</span>
								<span>{formatCurrency(order.subtotal)}</span>
							</div>
							<div class="order-summary__row">
								<span>Frete</span>
								<span>{formatCurrency(order.shipping)}</span>
							</div>
							{order.discount > 0 && (
								<div class="order-summary__row">
									<span>Desconto</span>
									<span>-{formatCurrency(order.discount)}</span>
								</div>
							)}
							<div class="order-summary__row order-summary__row--total">
								<span>Total</span>
								<span>{formatCurrency(order.total)}</span>
							</div>
						</div>
					</div>

					<!-- Shipping Address -->
					<div class="dashboard__card">
						<div class="dashboard__card-header">
							<h2 class="dashboard__card-title">Endereço de entrega</h2>
						</div>
						<div class="address-info">
							<p class="address-name">{order.shippingAddress.name}</p>
							<p>{order.shippingAddress.street}, {order.shippingAddress.number}</p>
							{order.shippingAddress.complement && <p>{order.shippingAddress.complement}</p>}
							<p>{order.shippingAddress.neighborhood}</p>
							<p>{order.shippingAddress.city} - {order.shippingAddress.state}</p>
							<p>CEP: {order.shippingAddress.zipCode}</p>
						</div>
					</div>

					<!-- Payment Info -->
					<div class="dashboard__card">
						<div class="dashboard__card-header">
							<h2 class="dashboard__card-title">Pagamento</h2>
						</div>
						<div class="payment-info">
							<p class="payment-method">{order.paymentMethod}</p>
							{order.paymentDetails && (
								<p class="payment-details">{order.paymentDetails}</p>
							)}
						</div>
					</div>
				</div>
			</>
		)}
	</div>
</Dashboard>

<style>
	.back-link {
		display: inline-flex;
		align-items: center;
		gap: 8px;
		color: var(--color-text-primary);
		font-family: var(--font-sans);
		font-size: 14px;
		text-decoration: none;
		margin-bottom: 24px;
	}

	.back-link:hover {
		color: var(--color-text-secondary);
	}

	.error-message {
		padding: 16px;
		background: #fee2e2;
		border-radius: 8px;
		color: #991b1b;
		font-family: var(--font-sans);
		font-size: 15px;
		margin-bottom: 24px;
	}

	.order-grid {
		display: grid;
		grid-template-columns: 1fr 1fr;
		gap: 24px;
	}

	.order-grid .dashboard__card:first-child,
	.order-grid .dashboard__card:nth-child(2) {
		grid-column: span 1;
	}

	.cancelled-notice {
		padding: 16px;
		background: #fee2e2;
		border-radius: 8px;
		color: #991b1b;
		font-family: var(--font-sans);
		font-size: 14px;
	}

	.tracking-info {
		margin-top: 24px;
		padding-top: 24px;
		border-top: 1px solid var(--color-border);
	}

	.tracking-label {
		font-family: var(--font-sans);
		font-size: 14px;
		color: var(--color-text-primary);
		margin: 0 0 8px;
	}

	.tracking-code {
		display: inline-flex;
		align-items: center;
		gap: 8px;
		padding: 8px 16px;
		background: var(--color-bg-primary);
		border-radius: 6px;
		font-family: var(--font-mono, monospace);
		font-size: 14px;
		font-weight: 600;
		color: var(--color-accent);
		text-decoration: none;
	}

	.tracking-code:hover {
		background: var(--color-border);
	}

	.address-info,
	.payment-info {
		font-family: var(--font-sans);
		font-size: 15px;
		line-height: 1.6;
		color: var(--color-text-secondary);
	}

	.address-info p,
	.payment-info p {
		margin: 0;
	}

	.address-name {
		font-weight: 600;
		margin-bottom: 8px !important;
	}

	.payment-method {
		font-weight: 600;
	}

	.payment-details {
		color: var(--color-text-primary);
		margin-top: 4px !important;
	}

	@media (max-width: 768px) {
		.order-grid {
			grid-template-columns: 1fr;
		}

		.order-grid .dashboard__card {
			grid-column: span 1;
		}
	}
</style>
