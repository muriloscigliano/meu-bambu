---
export const prerender = false;

import Dashboard from '../../layouts/Dashboard.astro';
import { getProfile, updateProfile } from '../../services/api';

// Check authentication
const token = Astro.cookies.get('auth_token')?.value;
if (!token) {
	return Astro.redirect('/entrar?redirect=/minha-conta/perfil');
}

let profile: any = null;
let error = null;
let success = false;

// Handle POST (update profile)
if (Astro.request.method === 'POST') {
	const formData = await Astro.request.formData();
	const data = {
		name: formData.get('name') as string,
		email: formData.get('email') as string,
		phone: formData.get('phone') as string,
		cpf: formData.get('cpf') as string,
		address: {
			street: formData.get('street') as string,
			number: formData.get('number') as string,
			complement: formData.get('complement') as string,
			neighborhood: formData.get('neighborhood') as string,
			city: formData.get('city') as string,
			state: formData.get('state') as string,
			zipCode: formData.get('zipCode') as string,
		}
	};

	try {
		await updateProfile(token, data);
		success = true;
	} catch (e) {
		error = 'Erro ao atualizar perfil. Tente novamente.';
		console.error('Failed to update profile:', e);
	}
}

// Fetch current profile
try {
	profile = await getProfile(token);
} catch (e) {
	error = 'Erro ao carregar perfil. Tente novamente.';
	console.error('Failed to fetch profile:', e);
}

const states = [
	'AC', 'AL', 'AP', 'AM', 'BA', 'CE', 'DF', 'ES', 'GO', 'MA',
	'MT', 'MS', 'MG', 'PA', 'PB', 'PR', 'PE', 'PI', 'RJ', 'RN',
	'RS', 'RO', 'RR', 'SC', 'SP', 'SE', 'TO'
];
---

<Dashboard title="Meu Perfil | Meu Bambu" activeTab="perfil">
	<div class="dashboard__header">
		<h1 class="dashboard__title">Meu Perfil</h1>
		<p class="dashboard__subtitle">Gerencie suas informações pessoais</p>
	</div>

	{error && (
		<div class="alert alert--error">
			<p>{error}</p>
		</div>
	)}

	{success && (
		<div class="alert alert--success">
			<p>Perfil atualizado com sucesso!</p>
		</div>
	)}

	{profile && (
		<form method="POST" class="profile-form">
			<!-- Personal Info -->
			<div class="dashboard__card">
				<div class="dashboard__card-header">
					<h2 class="dashboard__card-title">Informações pessoais</h2>
				</div>

				<div class="form-row">
					<div class="form-group">
						<label class="form-label" for="name">Nome completo</label>
						<input
							type="text"
							id="name"
							name="name"
							class="form-input"
							value={profile.name}
							required
						/>
					</div>
					<div class="form-group">
						<label class="form-label" for="email">E-mail</label>
						<input
							type="email"
							id="email"
							name="email"
							class="form-input"
							value={profile.email}
							required
						/>
					</div>
				</div>

				<div class="form-row">
					<div class="form-group">
						<label class="form-label" for="phone">Telefone</label>
						<input
							type="tel"
							id="phone"
							name="phone"
							class="form-input"
							value={profile.phone}
							placeholder="(00) 00000-0000"
						/>
					</div>
					<div class="form-group">
						<label class="form-label" for="cpf">CPF</label>
						<input
							type="text"
							id="cpf"
							name="cpf"
							class="form-input"
							value={profile.cpf}
							placeholder="000.000.000-00"
						/>
					</div>
				</div>
			</div>

			<!-- Address -->
			<div class="dashboard__card">
				<div class="dashboard__card-header">
					<h2 class="dashboard__card-title">Endereço de entrega</h2>
				</div>

				<div class="form-row">
					<div class="form-group" style="flex: 2">
						<label class="form-label" for="street">Rua</label>
						<input
							type="text"
							id="street"
							name="street"
							class="form-input"
							value={profile.address?.street}
						/>
					</div>
					<div class="form-group" style="flex: 1">
						<label class="form-label" for="number">Número</label>
						<input
							type="text"
							id="number"
							name="number"
							class="form-input"
							value={profile.address?.number}
						/>
					</div>
				</div>

				<div class="form-row">
					<div class="form-group">
						<label class="form-label" for="complement">Complemento</label>
						<input
							type="text"
							id="complement"
							name="complement"
							class="form-input"
							value={profile.address?.complement}
							placeholder="Apto, bloco, etc."
						/>
					</div>
					<div class="form-group">
						<label class="form-label" for="neighborhood">Bairro</label>
						<input
							type="text"
							id="neighborhood"
							name="neighborhood"
							class="form-input"
							value={profile.address?.neighborhood}
						/>
					</div>
				</div>

				<div class="form-row">
					<div class="form-group">
						<label class="form-label" for="city">Cidade</label>
						<input
							type="text"
							id="city"
							name="city"
							class="form-input"
							value={profile.address?.city}
						/>
					</div>
					<div class="form-group">
						<label class="form-label" for="state">Estado</label>
						<select id="state" name="state" class="form-input">
							<option value="">Selecione</option>
							{states.map(state => (
								<option value={state} selected={profile.address?.state === state}>
									{state}
								</option>
							))}
						</select>
					</div>
					<div class="form-group">
						<label class="form-label" for="zipCode">CEP</label>
						<input
							type="text"
							id="zipCode"
							name="zipCode"
							class="form-input"
							value={profile.address?.zipCode}
							placeholder="00000-000"
						/>
					</div>
				</div>
			</div>

			<!-- Actions -->
			<div class="form-actions">
				<button type="submit" class="btn-primary">Salvar alterações</button>
			</div>
		</form>
	)}
</Dashboard>

<style>
	.alert {
		padding: 16px;
		border-radius: 8px;
		font-family: var(--font-sans);
		font-size: 15px;
		margin-bottom: 24px;
	}

	.alert--error {
		background: #fee2e2;
		color: #991b1b;
	}

	.alert--success {
		background: #d1fae5;
		color: #065f46;
	}

	.alert p {
		margin: 0;
	}

	.profile-form {
		display: flex;
		flex-direction: column;
		gap: 24px;
	}

	.form-actions {
		display: flex;
		justify-content: flex-end;
	}

	.form-row {
		display: flex;
		gap: 16px;
	}

	.form-row .form-group {
		flex: 1;
	}

	@media (max-width: 768px) {
		.form-row {
			flex-direction: column;
		}
	}
</style>

<script>
	// CEP auto-fill
	const zipCodeInput = document.getElementById('zipCode') as HTMLInputElement;
	if (zipCodeInput) {
		zipCodeInput.addEventListener('blur', async (e) => {
			const cep = (e.target as HTMLInputElement).value.replace(/\D/g, '');
			if (cep.length !== 8) return;

			try {
				const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
				const data = await response.json();

				if (!data.erro) {
					(document.getElementById('street') as HTMLInputElement).value = data.logradouro || '';
					(document.getElementById('neighborhood') as HTMLInputElement).value = data.bairro || '';
					(document.getElementById('city') as HTMLInputElement).value = data.localidade || '';
					(document.getElementById('state') as HTMLSelectElement).value = data.uf || '';
				}
			} catch (error) {
				console.error('Failed to fetch CEP:', error);
			}
		});
	}

	// Phone mask
	const phoneInput = document.getElementById('phone') as HTMLInputElement;
	if (phoneInput) {
		phoneInput.addEventListener('input', (e) => {
			let value = (e.target as HTMLInputElement).value.replace(/\D/g, '');
			if (value.length > 11) value = value.slice(0, 11);

			if (value.length > 6) {
				value = `(${value.slice(0, 2)}) ${value.slice(2, 7)}-${value.slice(7)}`;
			} else if (value.length > 2) {
				value = `(${value.slice(0, 2)}) ${value.slice(2)}`;
			} else if (value.length > 0) {
				value = `(${value}`;
			}

			(e.target as HTMLInputElement).value = value;
		});
	}

	// CPF mask
	const cpfInput = document.getElementById('cpf') as HTMLInputElement;
	if (cpfInput) {
		cpfInput.addEventListener('input', (e) => {
			let value = (e.target as HTMLInputElement).value.replace(/\D/g, '');
			if (value.length > 11) value = value.slice(0, 11);

			if (value.length > 9) {
				value = `${value.slice(0, 3)}.${value.slice(3, 6)}.${value.slice(6, 9)}-${value.slice(9)}`;
			} else if (value.length > 6) {
				value = `${value.slice(0, 3)}.${value.slice(3, 6)}.${value.slice(6)}`;
			} else if (value.length > 3) {
				value = `${value.slice(0, 3)}.${value.slice(3)}`;
			}

			(e.target as HTMLInputElement).value = value;
		});
	}

	// CEP mask
	if (zipCodeInput) {
		zipCodeInput.addEventListener('input', (e) => {
			let value = (e.target as HTMLInputElement).value.replace(/\D/g, '');
			if (value.length > 8) value = value.slice(0, 8);

			if (value.length > 5) {
				value = `${value.slice(0, 5)}-${value.slice(5)}`;
			}

			(e.target as HTMLInputElement).value = value;
		});
	}
</script>
