---
export const prerender = false;

import Dashboard from '../../layouts/Dashboard.astro';
import { getPaymentMethods, removePaymentMethod } from '../../services/api';

// Check authentication
const token = Astro.cookies.get('auth_token')?.value;
if (!token) {
	return Astro.redirect('/entrar?redirect=/minha-conta/pagamentos');
}

// Handle POST (remove payment method)
if (Astro.request.method === 'POST') {
	const formData = await Astro.request.formData();
	const action = formData.get('action');
	const paymentMethodId = formData.get('paymentMethodId') as string;

	if (action === 'remove' && paymentMethodId) {
		try {
			await removePaymentMethod(token, paymentMethodId);
			return Astro.redirect('/minha-conta/pagamentos?success=removed');
		} catch (e) {
			console.error('Failed to remove payment method:', e);
		}
	}
}

let paymentMethods: any[] = [];
let error = null;

try {
	paymentMethods = await getPaymentMethods(token);
} catch (e) {
	error = 'Erro ao carregar métodos de pagamento.';
	console.error('Failed to fetch payment methods:', e);
}

const success = Astro.url.searchParams.get('success');

const getCardBrand = (brand: string) => {
	const brands: Record<string, string> = {
		visa: 'VISA',
		mastercard: 'MC',
		amex: 'AMEX',
		elo: 'ELO',
		hipercard: 'HIPER'
	};
	return brands[brand.toLowerCase()] || brand.toUpperCase();
};
---

<Dashboard title="Pagamentos | Meu Bambu" activeTab="pagamentos">
	<div class="dashboard__header">
		<h1 class="dashboard__title">Métodos de Pagamento</h1>
		<p class="dashboard__subtitle">Gerencie seus cartões salvos</p>
	</div>

	{error && (
		<div class="alert alert--error">
			<p>{error}</p>
		</div>
	)}

	{success === 'removed' && (
		<div class="alert alert--success">
			<p>Método de pagamento removido com sucesso!</p>
		</div>
	)}

	<div class="dashboard__card">
		<div class="dashboard__card-header">
			<h2 class="dashboard__card-title">Cartões salvos</h2>
		</div>

		{paymentMethods.length === 0 && (
			<div class="empty-state">
				<svg class="empty-state__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
					<path d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" stroke-linecap="round" stroke-linejoin="round"/>
				</svg>
				<h3 class="empty-state__title">Nenhum cartão salvo</h3>
				<p class="empty-state__text">Seus cartões serão salvos automaticamente após a primeira compra.</p>
			</div>
		)}

		{paymentMethods.length > 0 && (
			<div class="payment-methods">
				{paymentMethods.map(method => (
					<div class="payment-card">
						<div class="payment-card__info">
							<div class="payment-card__icon">
								{getCardBrand(method.brand)}
							</div>
							<div class="payment-card__details">
								<span class="payment-card__number">
									•••• •••• •••• {method.last4}
								</span>
								<span class="payment-card__expiry">
									Expira em {method.expMonth}/{method.expYear}
								</span>
							</div>
						</div>
						<div class="payment-card__actions">
							<form method="POST">
								<input type="hidden" name="action" value="remove" />
								<input type="hidden" name="paymentMethodId" value={method.id} />
								<button
									type="submit"
									class="payment-card__btn payment-card__btn--remove"
									onclick="return confirm('Remover este cartão?')"
								>
									Remover
								</button>
							</form>
						</div>
					</div>
				))}
			</div>
		)}
	</div>

	<!-- Security Info Section -->
	<div class="security-info">
		<div class="security-info__header">
			<svg class="security-info__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
				<path d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" stroke-linecap="round" stroke-linejoin="round"/>
			</svg>
			<span>Segurança dos seus dados</span>
		</div>
		<div class="security-info__grid">
			<div class="security-info__item">
				<div class="security-info__item-icon">
					<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
						<path d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" stroke-linecap="round" stroke-linejoin="round"/>
					</svg>
				</div>
				<div class="security-info__item-content">
					<strong>Pagamento seguro</strong>
					<p>Seus dados são processados com criptografia pelo nosso parceiro de pagamentos.</p>
				</div>
			</div>
			<div class="security-info__item">
				<div class="security-info__item-icon">
					<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
						<path d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01" stroke-linecap="round" stroke-linejoin="round"/>
					</svg>
				</div>
				<div class="security-info__item-content">
					<strong>Dados protegidos</strong>
					<p>Não armazenamos os dados completos do seu cartão em nossos servidores.</p>
				</div>
			</div>
			<div class="security-info__item">
				<div class="security-info__item-icon">
					<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
						<path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke-linecap="round" stroke-linejoin="round"/>
					</svg>
				</div>
				<div class="security-info__item-content">
					<strong>Controle total</strong>
					<p>Remova qualquer cartão salvo a qualquer momento com um clique.</p>
				</div>
			</div>
			<div class="security-info__item">
				<div class="security-info__item-icon">
					<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
						<path d="M12 6v6m0 0v6m0-6h6m-6 0H6" stroke-linecap="round" stroke-linejoin="round"/>
					</svg>
				</div>
				<div class="security-info__item-content">
					<strong>Adicionar cartões</strong>
					<p>Novos cartões são salvos automaticamente ao realizar uma compra.</p>
				</div>
			</div>
		</div>
	</div>
</Dashboard>

<style>
	.alert {
		padding: 16px;
		border-radius: 8px;
		font-family: var(--font-sans);
		font-size: 15px;
		margin-bottom: 24px;
	}

	.alert--error {
		background: #fee2e2;
		color: #991b1b;
	}

	.alert--success {
		background: #d1fae5;
		color: #065f46;
	}

	.alert p {
		margin: 0;
	}

	.info-content {
		font-family: var(--font-sans);
		font-size: 14px;
		color: var(--color-text-primary);
		line-height: 1.6;
	}

	.info-content ul {
		margin: 0;
		padding-left: 20px;
	}

	.info-content li {
		margin-bottom: 8px;
	}

	.info-content li:last-child {
		margin-bottom: 0;
	}

	/* Security Info Section */
	.security-info {
		margin-top: 32px;
		padding: 28px;
		background: linear-gradient(135deg, rgba(210, 143, 61, 0.04) 0%, rgba(98, 83, 62, 0.03) 100%);
		border: 1px solid rgba(98, 83, 62, 0.08);
		border-radius: 16px;
	}

	.security-info__header {
		display: flex;
		align-items: center;
		gap: 12px;
		margin-bottom: 24px;
		padding-bottom: 20px;
		border-bottom: 1px solid rgba(98, 83, 62, 0.08);
	}

	.security-info__header svg {
		width: 24px;
		height: 24px;
		color: var(--color-accent);
	}

	.security-info__header span {
		font-family: var(--font-sans);
		font-size: 14px;
		font-weight: 600;
		color: var(--color-text-secondary);
		text-transform: uppercase;
		letter-spacing: 0.06em;
	}

	.security-info__grid {
		display: grid;
		grid-template-columns: repeat(2, 1fr);
		gap: 20px;
	}

	.security-info__item {
		display: flex;
		gap: 14px;
		padding: 16px;
		background: var(--color-bg-secondary);
		border-radius: 12px;
		border: 1px solid rgba(98, 83, 62, 0.06);
		transition: all 0.2s ease;
	}

	.security-info__item:hover {
		border-color: rgba(98, 83, 62, 0.12);
		box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
	}

	.security-info__item-icon {
		flex-shrink: 0;
		width: 40px;
		height: 40px;
		display: flex;
		align-items: center;
		justify-content: center;
		background: rgba(210, 143, 61, 0.08);
		border-radius: 10px;
	}

	.security-info__item-icon svg {
		width: 20px;
		height: 20px;
		color: var(--color-accent);
	}

	.security-info__item-content {
		flex: 1;
	}

	.security-info__item-content strong {
		display: block;
		font-family: var(--font-sans);
		font-size: 14px;
		font-weight: 600;
		color: var(--color-text-secondary);
		margin-bottom: 4px;
	}

	.security-info__item-content p {
		margin: 0;
		font-family: var(--font-sans);
		font-size: 13px;
		color: var(--color-text-dark);
		opacity: 0.7;
		line-height: 1.5;
	}

	@media (max-width: 768px) {
		.security-info__grid {
			grid-template-columns: 1fr;
		}

		.security-info {
			padding: 20px;
		}
	}
</style>
